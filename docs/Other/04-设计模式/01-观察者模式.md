## ä»€ä¹ˆè§‚å¯Ÿè€…æ¨¡å¼

> **å®šä¹‰å¯¹è±¡é—´çš„ä¸€å¯¹å¤šä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡ï¼ˆè§‚å¯Ÿè€…ï¼‰éƒ½ä¼šè‡ªåŠ¨æ”¶åˆ°é€šçŸ¥å¹¶æ›´æ–°ã€‚**

## ä¸€ã€ç°å®ç±»æ¯” ğŸŒ°

ğŸ“° æŠ¥çº¸è®¢é˜…ï¼š
- ä½ ï¼ˆ**è§‚å¯Ÿè€…**ï¼‰å‘æŠ¥ç¤¾ï¼ˆ**è¢«è§‚å¯Ÿè€…/ä¸»é¢˜**ï¼‰è®¢é˜…æŠ¥çº¸ã€‚
- åªè¦æŠ¥ç¤¾**å‘å¸ƒæ–°ä¸€æœŸæŠ¥çº¸**ï¼ˆçŠ¶æ€å˜åŒ–ï¼‰ï¼Œå°±ä¼š**è‡ªåŠ¨é€æŠ¥åˆ°ä½ å®¶**ï¼ˆé€šçŸ¥ä½ ï¼‰ã€‚
- å…¶ä»–äººä¹Ÿå¯ä»¥è®¢é˜…ï¼ŒæŠ¥ç¤¾ä¸éœ€è¦çŸ¥é“å…·ä½“æ˜¯è°åœ¨çœ‹ï¼Œåªéœ€â€œå¹¿æ’­â€å³å¯ã€‚
- ä½ å¯ä»¥éšæ—¶**å–æ¶ˆè®¢é˜…**ï¼ˆè§£è€¦ï¼‰ã€‚

âœ… è¿™å°±æ˜¯å…¸å‹çš„â€œä¸€å¯¹å¤šâ€ã€â€œè‡ªåŠ¨é€šçŸ¥â€ã€â€œæ¾è€¦åˆâ€ã€‚

---

## äºŒã€æ ¸å¿ƒè§’è‰²

| è§’è‰² | èŒè´£ |
|------|------|
| **Subjectï¼ˆè¢«è§‚å¯Ÿè€… / ä¸»é¢˜ï¼‰** | ç®¡ç†è§‚å¯Ÿè€…åˆ—è¡¨ï¼Œæä¾›æ³¨å†Œï¼ˆattachï¼‰ã€ç§»é™¤ï¼ˆdetachï¼‰ã€é€šçŸ¥ï¼ˆnotifyï¼‰æ–¹æ³• |
| **Observerï¼ˆè§‚å¯Ÿè€…ï¼‰** | å®šä¹‰ä¸€ä¸ªæ›´æ–°æ¥å£ï¼ˆå¦‚ `update()`ï¼‰ï¼Œä¾›è¢«è§‚å¯Ÿè€…è°ƒç”¨ |
| **ConcreteSubjectï¼ˆå…·ä½“è¢«è§‚å¯Ÿè€…ï¼‰** | å­˜å‚¨çŠ¶æ€ï¼Œå½“çŠ¶æ€å˜åŒ–æ—¶è°ƒç”¨ `notify()` |
| **ConcreteObserverï¼ˆå…·ä½“è§‚å¯Ÿè€…ï¼‰** | å®ç° `update()`ï¼Œæ ¹æ®ä¸»é¢˜çŠ¶æ€æ›´æ–°è‡ªèº« |

---

## ä¸‰ã€ä»£ç å®ç°

```js
let publisher = {
  subscribers: {
    any: []
  },

  // å°†è®¢é˜…è€…æ·»åŠ åˆ° subscribers ä¸­å¯¹åº”çš„æ•°ç»„ä¸­
  subscribe: function (fn, type = 'any') {
    if (typeof this.subscribers[type] === 'undefined') {
      this.subscribers[type] = [];
    }
    this.subscribers[type].push(fn);
  },

  // åœ¨ subscribers ä¸­åˆ é™¤è®¢é˜…è€…
  unsubscribe: function (fn, type) {
    this.visitSubscribers('unsubscribe', fn, type);
  },

  // å¾ªç¯éå† subscribers ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œå¹¶è°ƒç”¨ä»–ä»¬æ³¨å†Œæ—¶æä¾›çš„æ–¹æ³•
  publish: function (publication, type) {
    this.visitSubscribers('publish', publication, type);
  },

  // åœ¨ publish è°ƒç”¨
  visitSubscribers: function (action, arg, type = 'any') {
    this.subscribers[type].forEach((currentValue, index, array) => {
      if (action === 'publish') {
        // å‡½æ•°è°ƒç”¨
        currentValue(arg);
      } else if (action === 'unsubscribe') {
        if (currentValue === arg) {
          this.subscribers[type].splice(index, 1);
        }
      }
    });
  }
};

let funcA = function (cl) {
  console.log('msg1' + cl);
};

let funcB = function (cl) {
  console.log('msg2' + cl);
};

// æ·»åŠ  è®¢é˜…è€… funcA
publisher.subscribe(funcA);
// æ·»åŠ  è®¢é˜…è€… funcB
publisher.subscribe(funcB);
// åˆ é™¤ è®¢é˜…è€… funcB
publisher.unsubscribe(funcB);

publisher.publish(' in publisher'); // msg1 in publisher
```


## å››ã€å‘å¸ƒ-è®¢é˜…æ¨¡å¼

```js
var pubsub = {};
(function (q) {
  // å›è°ƒå‡½æ•°å­˜æ”¾çš„æ•°ç»„
  var topics = {},
    subUid = -1;
  // å‘å¸ƒæˆ–å¹¿æ’­äº‹ä»¶ï¼ŒåŒ…å«ç‰¹å®šçš„ topic åç§°å’Œå‚æ•°(æ¯”å¦‚ä¼ é€’çš„æ•°æ®)
  q.publish = function (topic, args) {
    if (!topics[topic]) {
      return false;
    }
    var subscribers = topics[topic],
      len = subscribers ? subscribers.length : 0;
    while (len--) {
      subscribers[len].func(topic, args);
    }
    return this;
  };
  // é€šè¿‡ç‰¹å®šçš„åç§°å’Œå›è°ƒå‡½æ•°è®¢é˜…äº‹ä»¶ï¼Œtopic/event è§¦å‘æ—¶æ‰§è¡Œäº‹ä»¶
  q.subscribe = function (topic, func) {
    if (!topics[topic]) {
      topics[topic] = [];
    }
    var token = (++subUid).toString();
    topics[topic].push({
      token: token,
      func: func
    });
    return token;
  };
  // åŸºäºè®¢é˜…ä¸Šçš„æ ‡è®°å¼•ç”¨ï¼Œé€šè¿‡ç‰¹å®š topic å–æ¶ˆè®¢é˜…
  q.unsubscribe = function (token) {
    for (var m in topics) {
      if (topics[m]) {
        for (var i = 0, j = topics[m].length; i < j; i++) {
          if (topics[m][i].token === token) {
            topics[m].splice(i, 1);
            return token;
          }
        }
      }
    }
    return this;
  };
})(pubsub);

// ç®€å•çš„æ¶ˆæ¯è®°å½•å™¨è®°æ‰¿æ‰€æœ‰é€šè¿‡è®¢è€…æ¥æ”¶åˆ°çš„ä¸»é¢˜(topie)å’Œæ•°å™¨
var messagelogger = function (topics, data) {
  console.log('Logging' + topics + ' => ' + JSON.stringify(data));
};
var topicName = 'inbox/newMessage';
//è®¢é˜…è€…ç›‘å¬è®¢é˜…çš„ topic;ä¸€æ—¦è¯¥topcå¹¿æ’­ä¸€ä¸ªé€šçŸ¥ï¼Œè®¢ç€æ•°è°ƒç”¨å›è°ƒå‡½æ•°
var subscription = pubsub.subscribe(topicName, messagelogger);
// å‘å¸ƒè€…è´Ÿè´£å‘å¸ƒç¨‹åºæ„Ÿå…´è¶£çš„ topicæˆ–é€šçŸ¥ï¼Œä¾‹å¦‚:
pubsub.publish(topicName, 'hello world!');
// æˆ–è€…
pubsub.publish(topicName, ['test', 'a', 'b', 'c']);
// æˆ–è€…
pubsub.publish(topicName, { sender: 'hello@google.com', body: 'Hey again!' });
// å¦‚æœè®¢é˜…è€…ä¸æƒ³è¢«é€šçŸ¥äº†ï¼Œä¹Ÿå¯ä»¥å–æ¶ˆè®¢é˜…
pubsub.unsubscribe('0');
//ä¸€æ—¦å–æ¶ˆè®¢é˜…ï¼Œä¸‹é¢çš„ä»£ç æ‰§è¡Œåå°†ä¸ä¼šè®°å½•æ¶ˆæ¯ï¼Œå› ä¸ºè®¢é˜…è€…ä¸å†è¿›è¡Œç›‘å¬äº†
pubsub.publish(topicName, 'Hello! are you still there?');
```


### æ‰‹å†™ä¸€ä¸ªå‘å¸ƒ-è®¢é˜…æ¨¡å¼

- on()ï¼šè´Ÿè´£æ³¨å†Œäº‹ä»¶çš„ç›‘å¬å™¨ï¼ŒæŒ‡å®šäº‹ä»¶è§¦å‘æ—¶çš„å›è°ƒå‡½æ•°ã€‚
- emit()ï¼šè´Ÿè´£è§¦å‘äº‹ä»¶ï¼Œå¯ä»¥é€šè¿‡ä¼ å‚ä½¿å…¶åœ¨è§¦å‘çš„æ—¶å€™æºå¸¦æ•°æ® ã€‚
- off()ï¼šè´Ÿè´£ç›‘å¬å™¨çš„åˆ é™¤ã€‚

```js
class myEventEmitter {
  constructor() {
    this.eventMap = {};
  }
  on(type, handler) {
    if (!(handler instanceof Function)) {
      throw new Error('è¯·ä¼ ä¸€ä¸ªå‡½æ•°');
    }
    if (!this.eventMap[type]) {
      this.eventMap[type] = [];
    }
    this.eventMap[type].push(handler);
  }
  emit(type, params) {
    if (this.eventMap[type]) {
      this.eventMap[type].forEach((handler, index) => {
        handler(params);
      });
    }
  }
  off(type, handler) {
    if (this.eventMap[type]) {
      this.eventMap[type].splice(this.eventMap[type].indexOf(handler) >>> 0, 1);
    }
  }
}

const myEvent = new myEventEmitter();

const testHandler = function (params) {
  console.log(`testäº‹ä»¶è¢«è§¦å‘äº†ï¼ŒtestHandler æ¥æ”¶åˆ°çš„å…¥å‚æ˜¯${params}`);
};

// ç›‘å¬ test äº‹ä»¶
myEvent.on('test', testHandler);

// åœ¨è§¦å‘ test äº‹ä»¶çš„åŒæ—¶ï¼Œä¼ å…¥å¸Œæœ› testHandler æ„ŸçŸ¥çš„å‚æ•°
myEvent.emit('test', 'newState');
```

## è§‚å¯Ÿè€…æ¨¡å¼ä¸å‘å¸ƒ-è®¢é˜…æ¨¡å¼çš„åŒºåˆ«ï¼Ÿ

| ç‰¹æ€§ | è§‚å¯Ÿè€…æ¨¡å¼ | å‘å¸ƒ-è®¢é˜…æ¨¡å¼ |
|------|-----------|--------------|
| **è€¦åˆåº¦** | è¢«è§‚å¯Ÿè€…æŒæœ‰è§‚å¯Ÿè€…å¼•ç”¨ï¼ˆè¾ƒç´§ï¼‰ | é€šè¿‡**äº‹ä»¶æ€»çº¿/ä¸­é—´ä»¶**è§£è€¦ï¼ˆæ›´æ¾ï¼‰ |
| **åŒæ­¥/å¼‚æ­¥** | é€šå¸¸æ˜¯åŒæ­¥é€šçŸ¥ | é€šå¸¸æ˜¯å¼‚æ­¥ï¼ˆå¦‚æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ |
| **å®ç°å¤æ‚åº¦** | ç®€å• | éœ€è¦é¢å¤–çš„è°ƒåº¦ä¸­å¿ƒ |

> ğŸ’¡ å‘å¸ƒ-è®¢é˜…æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„**å¢å¼ºç‰ˆ**ï¼Œé€‚ç”¨äºè·¨ç³»ç»Ÿã€å¼‚æ­¥åœºæ™¯ã€‚
