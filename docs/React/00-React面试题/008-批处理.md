åœ¨ React å‡½æ•°ç»„ä»¶ä¸­ï¼Œ**å½“å¤šä¸ª `useState` çš„çŠ¶æ€åŒæ—¶æ›´æ–°æ—¶ï¼ŒReact å¹¶ä¸ä¼šä¸ºæ¯ä¸ªçŠ¶æ€å˜åŒ–åˆ†åˆ«è§¦å‘ä¸€æ¬¡é‡æ–°æ¸²æŸ“ï¼Œè€Œæ˜¯å°†å®ƒä»¬â€œæ‰¹å¤„ç†â€ï¼ˆbatchingï¼‰æˆä¸€æ¬¡é‡æ–°æ¸²æŸ“**ã€‚

---

## âœ… ä¸€ã€æ ¸å¿ƒæœºåˆ¶ï¼š**è‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆAutomatic Batchingï¼‰**

### ğŸ“Œ React 18+ çš„å…³é”®æ”¹è¿›
ä» **React 18 å¼€å§‹**ï¼Œæ— è®ºçŠ¶æ€æ›´æ–°å‘ç”Ÿåœ¨ä»€ä¹ˆä¸Šä¸‹æ–‡ï¼ˆäº‹ä»¶å¤„ç†å™¨ã€Promiseã€setTimeout ç­‰ï¼‰ï¼Œ**æ‰€æœ‰çŠ¶æ€æ›´æ–°éƒ½ä¼šè¢«è‡ªåŠ¨æ‰¹å¤„ç†**ï¼ˆé™¤éæ˜¾å¼ opt-outï¼‰ã€‚

> ğŸ”” åœ¨ React 17 åŠä¹‹å‰ï¼Œåªæœ‰ **React äº‹ä»¶å¤„ç†å™¨å†…éƒ¨** çš„æ›´æ–°ä¼šè¢«æ‰¹å¤„ç†ï¼›åœ¨ `setTimeout`ã€`Promise`ã€åŸç”Ÿäº‹ä»¶ä¸­åˆ™ä¸ä¼šã€‚

---

### ğŸ§ª ç¤ºä¾‹ï¼šå¤šä¸ª setState åŒæ—¶è°ƒç”¨

```jsx
import { useState } from 'react';

export default function App() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  const handleClick = () => {
    console.log('--- å¼€å§‹æ›´æ–° ---');
    setCount(c => c + 1);     // æ›´æ–° 1
    setFlag(f => !f);         // æ›´æ–° 2
    console.log('--- æ›´æ–°ç»“æŸ ---');
  };

  console.log('App rendered'); // è§‚å¯Ÿæ¸²æŸ“æ¬¡æ•°

  return (
    <div>
      <p>Count: {count}</p>
      <p>Flag: {flag ? 'ON' : 'OFF'}</p>
      <button onClick={handleClick}>Update Both</button>
    </div>
  );
}
```

### ğŸ” è¾“å‡ºç»“æœï¼ˆReact 18+ï¼‰ï¼š
```
--- å¼€å§‹æ›´æ–° ---
--- æ›´æ–°ç»“æŸ ---
App rendered   // â† åªæ‰“å°ä¸€æ¬¡ï¼
```

âœ… **ç»“è®º**ï¼šå°½ç®¡è°ƒç”¨äº†ä¸¤æ¬¡ `setState`ï¼Œä½†ç»„ä»¶**åªé‡æ–°æ¸²æŸ“äº†ä¸€æ¬¡**ã€‚

---

## âœ… äºŒã€åº•å±‚åŸç†ï¼šFiber ä¸ Update Queue

React å†…éƒ¨ä½¿ç”¨ **Fiber æ¶æ„**ç®¡ç†æ›´æ–°ï¼š

1. æ¯æ¬¡è°ƒç”¨ `setXXX`ï¼Œä¼šåˆ›å»ºä¸€ä¸ª **update å¯¹è±¡**ï¼Œå¹¶æ¨å…¥è¯¥ hook çš„ **update queue**ã€‚
2. React ä¼šå¯åŠ¨ä¸€ä¸ª **reconciliationï¼ˆåè°ƒï¼‰è¿‡ç¨‹**ã€‚
3. åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒReact **åˆå¹¶ï¼ˆmergeï¼‰åŒä¸€è½®äº‹ä»¶ä¸­çš„æ‰€æœ‰çŠ¶æ€æ›´æ–°**ã€‚
4. æœ€ç»ˆï¼Œç”¨**æœ€æ–°çš„çŠ¶æ€å€¼**æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„å‡½æ•°ç»„ä»¶é‡è¿è¡Œï¼ˆrenderï¼‰ã€‚

> ğŸ’¡ æ‰€ä»¥ï¼Œå‡½æ•°ç»„ä»¶çš„â€œåˆ·æ–°â€ = **æ•´ä¸ªå‡½æ•°é‡æ–°æ‰§è¡Œä¸€æ¬¡**ï¼Œä½¿ç”¨æ‰€æœ‰ state çš„æœ€æ–°å€¼ã€‚

---

## âœ… ä¸‰ã€ä¸åŒä¸Šä¸‹æ–‡ä¸‹çš„æ‰¹å¤„ç†è¡Œä¸ºï¼ˆReact 18+ï¼‰

| ä¸Šä¸‹æ–‡ | æ˜¯å¦æ‰¹å¤„ç†ï¼Ÿ | è¯´æ˜ |
|-------|-------------|------|
| React äº‹ä»¶å¤„ç†å™¨ï¼ˆå¦‚ `onClick`ï¼‰ | âœ… æ˜¯ | åŸç”Ÿæ”¯æŒ |
| `setTimeout` / `setInterval` | âœ… æ˜¯ï¼ˆReact 18+ï¼‰ | è‡ªåŠ¨æ‰¹å¤„ç† |
| `Promise.then` / `async/await` | âœ… æ˜¯ï¼ˆReact 18+ï¼‰ | è‡ªåŠ¨æ‰¹å¤„ç† |
| åŸç”Ÿ DOM äº‹ä»¶ï¼ˆå¦‚ `addEventListener`ï¼‰ | âœ… æ˜¯ï¼ˆReact 18+ï¼‰ | è‡ªåŠ¨æ‰¹å¤„ç† |
| `ReactDOM.flushSync(() => { ... })` | âŒ å¦ | å¼ºåˆ¶åŒæ­¥æ›´æ–°ï¼Œä¸æ‰¹å¤„ç† |

### ğŸ§ª ç¤ºä¾‹ï¼šåœ¨ setTimeout ä¸­æ›´æ–°å¤šä¸ªçŠ¶æ€

```js
const handleClick = () => {
  setTimeout(() => {
    setCount(c => c + 1);
    setFlag(f => !f);
  }, 0);
};
// â†’ ä»ç„¶åªè§¦å‘ä¸€æ¬¡ re-renderï¼ˆReact 18+ï¼‰
```

---

## âœ… å››ã€ç‰¹æ®Šæƒ…å†µï¼šå¦‚ä½•â€œé€€å‡ºâ€æ‰¹å¤„ç†ï¼Ÿ

å¦‚æœä½ **çœŸçš„éœ€è¦**è®©æ¯æ¬¡ `setState` éƒ½è§¦å‘ç‹¬ç«‹æ¸²æŸ“ï¼ˆæå°‘è§ï¼‰ï¼Œå¯ä»¥ç”¨ `flushSync`ï¼š

```jsx
import { flushSync } from 'react-dom';

const handleClick = () => {
  flushSync(() => {
    setCount(c => c + 1); // ç«‹å³è§¦å‘ä¸€æ¬¡ render
  });
  flushSync(() => {
    setFlag(f => !f);     // å†è§¦å‘ä¸€æ¬¡ render
  });
};
```

> âš ï¸ è­¦å‘Šï¼šè¿™ä¼š**æ˜¾è‘—é™ä½æ€§èƒ½**ï¼Œé€šå¸¸ç”¨äºéœ€è¦ç«‹å³è¯»å– DOM å¸ƒå±€çš„åœºæ™¯ï¼ˆå¦‚åŠ¨ç”»ï¼‰ã€‚

---

## âœ… äº”ã€å¸¸è§è¯¯åŒºæ¾„æ¸…

### âŒ è¯¯åŒº 1ï¼šâ€œæ¯ä¸ª setState éƒ½ä¼šè§¦å‘ä¸€æ¬¡ renderâ€
> âœ… æ­£ç¡®ï¼šReact ä¼š**åˆå¹¶åŒä¸€è½®æ›´æ–°ä¸­çš„æ‰€æœ‰ setState**ï¼Œåª render ä¸€æ¬¡ã€‚

### âŒ è¯¯åŒº 2ï¼šâ€œuseState æ˜¯ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥ä¼šåˆ†åˆ«æ›´æ–°â€
> âœ… æ­£ç¡®ï¼šè™½ç„¶æ¯ä¸ª `useState` æœ‰ç‹¬ç«‹çš„çŠ¶æ€å’Œ setterï¼Œä½† **React è°ƒåº¦å™¨ä¼šç»Ÿä¸€å¤„ç†æœ¬è½®æ‰€æœ‰æ›´æ–°**ã€‚

### âŒ è¯¯åŒº 3ï¼šâ€œuseReducer ä¸ä¼šæ‰¹å¤„ç†â€
> âœ… æ­£ç¡®ï¼š`useReducer` çš„ dispatch åŒæ ·å‚ä¸æ‰¹å¤„ç†ï¼

```js
dispatch({ type: 'inc' });
dispatch({ type: 'toggle' });
// â†’ åª render ä¸€æ¬¡
```

---

## âœ… æ€»ç»“

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| å¤šä¸ª `useState` åŒæ—¶æ›´æ–°ï¼Œä¼š render å‡ æ¬¡ï¼Ÿ | **1 æ¬¡**ï¼ˆReact 18+ è‡ªåŠ¨æ‰¹å¤„ç†ï¼‰ |
| æ¸²æŸ“æ—¶ç”¨çš„çŠ¶æ€å€¼æ˜¯ä»€ä¹ˆï¼Ÿ | **æ‰€æœ‰çŠ¶æ€çš„æœ€æ–°å€¼** |
| è¿™ä¸ªæœºåˆ¶å«ä»€ä¹ˆï¼Ÿ | **Automatic Batchingï¼ˆè‡ªåŠ¨æ‰¹å¤„ç†ï¼‰** |
| èƒ½å¦å…³é—­æ‰¹å¤„ç†ï¼Ÿ | å¯ä»¥ï¼Œç”¨ `flushSync`ï¼Œä½†**ä¸æ¨è** |
| `useReducer` æ˜¯å¦åŒæ ·æ‰¹å¤„ç†ï¼Ÿ | âœ… æ˜¯ |

> æ‰¹å¤„ç†æ­£æ˜¯è¿™ä¸€ç†å¿µçš„ä½“ç°ï¼šæ— è®ºä½ è°ƒç”¨å¤šå°‘æ¬¡ `setState`ï¼ŒReact åªå…³å¿ƒâ€œæœ€åçš„çŠ¶æ€â€ï¼Œå¹¶é«˜æ•ˆåœ°æ¸²æŸ“ä¸€æ¬¡ã€‚